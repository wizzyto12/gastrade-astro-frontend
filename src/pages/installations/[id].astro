---
import Layout from "~/layouts/Layout.astro";
import Section from "~/components/Section.astro";
import Container from "~/components/Container.astro";
import { siteName, phone } from "~/data/config";
import { installationGetInstallationsById } from "~/lib/client";
import type { InstallationGetInstallationsByIdResponses, PluginUploadFileDocument } from "~/lib/client";

export const prerender = false;

const { id } = Astro.params;
const strapiUrl = import.meta.env.STRAPI_URL ?? "";

let installation: InstallationGetInstallationsByIdResponses[200]["data"] | null = null;

function buildMediaUrl(media?: PluginUploadFileDocument | null): string | null {
    if (!media?.url) {
        return null;
    }

    if (media.url.startsWith("http")) {
        return media.url;
    }

    return `${strapiUrl}${media.url}`;
}

if (typeof id === "string" && id.length > 0) {
    try {
        const response = await installationGetInstallationsById({
            path: { id },
            query: {
                populate: "*",
            },
        });

        installation = (response as unknown as { data?: InstallationGetInstallationsByIdResponses[200]["data"] })?.data ?? null;
    } catch (error) {
        console.error("Failed to fetch installation", error);
    }
}

if (!installation) {
    Astro.response.status = 404;
}

const brandName = installation?.car?.model?.brand?.name ?? installation?.car?.model?.name ?? "";
const modelName = installation?.car?.model?.name ?? "";
const carTitle = [brandName, modelName, installation?.car?.year].filter(Boolean).join(" ") || "Монтаж на газова уредба";
const engine = installation?.car?.engine;
const published = installation?.publishedAt ? new Date(installation.publishedAt) : null;

const lpgComponents = [
    {
        label: "Електроника",
        name: installation?.lpg_ecus?.name,
        brand: installation?.lpg_ecus?.lpg_brand?.name,
    },
    {
        label: "Инжектори",
        name: installation?.lpg_injector?.name,
        brand: installation?.lpg_injector?.lpg_brand?.name,
    },
    {
        label: "Редуктор",
        name: installation?.lpg_reducer?.name,
        brand: installation?.lpg_reducer?.lpg_brand?.name,
    },
    {
        label: "Тороид/бутилка",
        name: installation?.lpg_tank?.name,
        brand: installation?.lpg_tank?.lpg_brand?.name,
    },
].filter((item) => item.name || item.brand);

const gallery = installation?.gallery ?? [];
const description = "Детайлен преглед на завършен монтаж на газова уредба и използвани компоненти.";
const metaTitle = `${carTitle} | Монтажи`;
---

<Layout pageTitle={`${metaTitle} | ${siteName}`} title={carTitle} description={description}>
    <Section class="border-b border-zinc-200 bg-zinc-50/60">
        <Container class="py-10 md:py-16">
            <a href="/installations" class="mb-6 inline-flex items-center gap-2 text-sm font-semibold text-violet-700 transition hover:text-violet-600">
                <svg class="size-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path
                        fill-rule="evenodd"
                        d="M12.79 4.23a.75.75 0 0 1 0 1.06L8.56 9.52l4.23 4.23a.75.75 0 1 1-1.06 1.06l-4.76-4.76a.75.75 0 0 1 0-1.06l4.76-4.76a.75.75 0 0 1 1.06 0Z"
                        clip-rule="evenodd"
                    />
                </svg>
                Всички монтажи
            </a>
            <div class="max-w-3xl">
                <p class="text-sm font-semibold uppercase tracking-wide text-violet-700">Галерия</p>
                <h1 class="mt-2 text-3xl font-bold leading-tight sm:text-4xl md:text-5xl">{carTitle}</h1>
                {engine && <p class="mt-2 text-lg text-zinc-600">Двигател: {engine}</p>}
                {published && (
                    <p class="mt-1 text-sm text-zinc-500">Публикувано на {published.toLocaleDateString("bg-BG")}</p>
                )}
            </div>
        </Container>
    </Section>

    <Section>
        <Container class="py-12 md:py-16">
            {installation ? (
                <div class="grid gap-10 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]">
                    <div class="space-y-6">
                        {gallery.length > 0 ? (
                            <div class="grid gap-4 md:grid-cols-2">
                                {gallery.map((media, index) => {
                                    const url = buildMediaUrl(media);
                                    if (!url) {
                                        return null;
                                    }

                                    return (
                                        <div
                                            class={`overflow-hidden rounded-2xl border border-zinc-200 bg-zinc-100 ${index === 0 ? "md:col-span-2" : ""}`}
                                        >
                                            <img
                                                src={url}
                                                alt={media.alternativeText ?? media.caption ?? carTitle}
                                                class="h-full w-full object-cover"
                                                loading={index === 0 ? "eager" : "lazy"}
                                            />
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div class="rounded-2xl border border-dashed border-zinc-300 bg-white p-10 text-center text-zinc-500">
                                Галерията ще бъде налична скоро.
                            </div>
                        )}
                    </div>

                    <aside class="space-y-6 rounded-2xl border border-zinc-200 bg-white p-6 shadow-sm md:p-8 lg:sticky lg:top-24">
                        <div>
                            <h2 class="text-xl font-semibold text-zinc-900">Детайли за монтажа</h2>
                            <p class="mt-2 text-sm text-zinc-600">
                                Внимателно подбран комплект и настройка за безпроблемна работа на газ и бензин.
                            </p>
                        </div>
                        <dl class="grid gap-4 text-sm text-zinc-700">
                            {brandName && (
                                <div>
                                    <dt class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Марка</dt>
                                    <dd class="mt-1 text-base text-zinc-900">{brandName}</dd>
                                </div>
                            )}
                            {modelName && (
                                <div>
                                    <dt class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Модел</dt>
                                    <dd class="mt-1 text-base text-zinc-900">{modelName}</dd>
                                </div>
                            )}
                            {installation?.car?.year && (
                                <div>
                                    <dt class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Година</dt>
                                    <dd class="mt-1 text-base text-zinc-900">{installation.car.year}</dd>
                                </div>
                            )}
                            {engine && (
                                <div>
                                    <dt class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Двигател</dt>
                                    <dd class="mt-1 text-base text-zinc-900">{engine}</dd>
                                </div>
                            )}
                        </dl>

                        {lpgComponents.length > 0 && (
                            <div class="space-y-4">
                                <h3 class="text-sm font-semibold uppercase tracking-wide text-zinc-500">Използвани компоненти</h3>
                                <ul class="space-y-3">
                                    {lpgComponents.map((component) => (
                                        <li class="rounded-xl border border-zinc-100 bg-zinc-50 px-4 py-3">
                                            <p class="text-xs font-semibold uppercase tracking-wide text-violet-700">{component.label}</p>
                                            <p class="text-base font-semibold text-zinc-900">{component.name ?? "Неизвестен компонент"}</p>
                                            {component.brand && (
                                                <p class="text-sm text-zinc-600">Марка: {component.brand}</p>
                                            )}
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        <div class="rounded-2xl border border-violet-100 bg-violet-50 px-5 py-5">
                            <h3 class="text-base font-semibold text-zinc-900">Искате подобен резултат?</h3>
                            <p class="mt-2 text-sm text-zinc-600">
                                Свържете се с нас за записване на час и индивидуална оферта.
                            </p>
                            <div class="mt-4 flex flex-col gap-2">
                                <a href={phone.href} class="inline-flex items-center gap-2 rounded-xl bg-violet-700 px-4 py-2 text-sm font-semibold text-white transition hover:bg-violet-600">
                                    Обади се: {phone.label}
                                    <svg class="size-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path d="M2 4.5A2.5 2.5 0 0 1 4.5 2h1.11c.6 0 1.13.36 1.35.91l.7 1.74a1.5 1.5 0 0 1-.3 1.52L6.3 7.6a10.46 10.46 0 0 0 6.09 6.09l1.43-1.06a1.5 1.5 0 0 1 1.52-.3l1.74.7c.55.22.91.75.91 1.35v1.11A2.5 2.5 0 0 1 15.5 18h-1A12.5 12.5 0 0 1 2 4.5Z" />
                                    </svg>
                                </a>
                                <a href="/contact" class="inline-flex items-center gap-2 rounded-xl border border-violet-200 px-4 py-2 text-sm font-semibold text-violet-700 transition hover:border-violet-300 hover:text-violet-800">
                                    Изпрати запитване
                                </a>
                            </div>
                        </div>
                    </aside>
                </div>
            ) : (
                <div class="rounded-2xl border border-dashed border-zinc-300 bg-white p-10 text-center text-zinc-500">
                    Монтажът не беше намерен или е премахнат.
                </div>
            )}
        </Container>
    </Section>
</Layout>
